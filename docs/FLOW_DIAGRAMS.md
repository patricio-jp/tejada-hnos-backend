# Diagramas del Sistema de Autenticaciรณn JWT

## ๐ Flujo de Autenticaciรณn Completo

```
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. POST /auth/login
       โ { email, password }
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  AuthController  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 2. Validar datos
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 3. Buscar usuario en BD
         โ 4. Comparar password hash
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โ   (PostgreSQL)   โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 5. Usuario encontrado
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ 6. Generar tokensโ
โ  - Access Token  โ
โ  - Refresh Token โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 7. Guardar refresh token en BD
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 8. Tokens guardados
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ  AuthController  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 9. Devolver respuesta
         โ { accessToken, refreshToken, user }
         โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ             โ
โ Guarda      โ
โ tokens      โ
โโโโโโโโโโโโโโโ
```

## ๐ Flujo de Peticiรณn Autenticada

```
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. GET /users
       โ Authorization: Bearer <access_token>
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ authenticate         โ
โ (Middleware)         โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ
       โ 2. Extraer token del header
       โ 3. Verificar firma y expiraciรณn
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ jwt.verify()     โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ Token vรกlido
         โ 4. Decodificar payload
         โ { userId, email, role }
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ Request.user = {...} โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ
       โ 5. Continuar al controlador
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  UserController  โ
โ                  โ
โ Acceso al usuarioโ
โ desde req.user   โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 6. Procesar peticiรณn
         โ 7. Devolver respuesta
         โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโโโโโโโโ
```

## ๐ก๏ธ Flujo de Autorizaciรณn por Rol

```
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ   (OPERARIO)โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. POST /admin/users
       โ Authorization: Bearer <token>
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ authenticate         โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ Token vรกlido
       โ req.user = { role: 'OPERARIO' }
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ authorize(ADMIN)     โ
โ (Middleware)         โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ
       โ 2. Verificar req.user.role
       โ 3. Comparar con roles permitidos
       โ
       โ OPERARIO !== ADMIN
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ 403 Forbidden        โ
โ                      โ
โ "No tienes permisos" โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ   Error 403 โ
โโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ   (ADMIN)   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. POST /admin/users
       โ Authorization: Bearer <token>
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ authenticate         โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ Token vรกlido
       โ req.user = { role: 'ADMIN' }
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ authorize(ADMIN)     โ
โโโโโโโโฌโโโโโโโโโโโโโโโโ
       โ
       โ ADMIN === ADMIN โ
       โ Autorizado
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  Controller      โ
โ  Procesa peticiรณnโ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ Respuesta exitosa
         โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโโโโโโโโ
```

## ๐ Flujo de Refresh Token

```
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ Access token expirado
       โ
       โ 1. POST /auth/refresh
       โ { refreshToken }
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  AuthController  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 2. Validar refresh token
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ jwt.verify()     โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 3. Buscar en BD
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โ                  โ
โ Buscar token     โ
โ Verificar:       โ
โ  - No revocado   โ
โ  - No expirado   โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ Token vรกlido
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ 4. Revocar token โ
โ    anterior      โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โ                  โ
โ UPDATE revoked   โ
โ = true           โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 5. Generar nuevos tokens
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ - Nuevo access   โ
โ - Nuevo refresh  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 6. Guardar nuevo refresh token
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 7. Devolver tokens
         โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ             โ
โ Actualiza   โ
โ tokens      โ
โโโโโโโโโโโโโโโ
```

## ๐ช Flujo de Logout

```
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. POST /auth/logout
       โ { refreshToken }
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  AuthController  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 2. Buscar refresh token
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โ                  โ
โ SELECT * FROM    โ
โ refresh_tokens   โ
โ WHERE token = ?  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ Token encontrado
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ   AuthService    โ
โ                  โ
โ 3. Revocar token โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ    Database      โ
โ                  โ
โ UPDATE           โ
โ SET revoked=true โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 4. Confirmaciรณn
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ  AuthController  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ 5. Respuesta exitosa
         โผ
โโโโโโโโโโโโโโโ
โ   Cliente   โ
โ             โ
โ Elimina     โ
โ tokens      โ
โ localmente  โ
โโโโโโโโโโโโโโโ
```

## ๐๏ธ Arquitectura del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      CLIENTE (Frontend)                  โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ  โ  Login Form  โ  โ  Auth Contextโ  โ  API Service โ  โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ HTTP/HTTPS
                         โ Authorization: Bearer <token>
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    EXPRESS SERVER                        โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              MIDDLEWARES                           โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโ โ โ
โ  โ  โexpress.json()โ  โ authenticate โ  โauthorizeโ โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                         โ                                โ
โ                         โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                   ROUTES                           โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โ  โ  /auth/*     โ  โ  /users/*    โ               โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                         โ                                โ
โ                         โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ               CONTROLLERS                          โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โ  โAuthControllerโ  โUserControllerโ               โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                         โ                                โ
โ                         โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                 SERVICES                           โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โ  โ AuthService  โ  โ UserService  โ               โ โ
โ  โ  โ              โ  โ              โ               โ โ
โ  โ  โ - login()    โ  โ - getAll()   โ               โ โ
โ  โ  โ - register() โ  โ - create()   โ               โ โ
โ  โ  โ - refresh()  โ  โ              โ               โ โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ               โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                         โ                                โ
โ                         โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ              DATABASE SERVICE                      โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โ  โ           TypeORM DataSource               โ โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ SQL Queries
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  PostgreSQL DATABASE                     โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ  โ    users     โ  โrefresh_tokensโ  โ    plots     โ  โ
โ  โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค  โโโโโโโโโโโโโโโโค  โ
โ  โ id           โ  โ id           โ  โ id           โ  โ
โ  โ email        โ  โ token        โ  โ ...          โ  โ
โ  โ passwordHash โ  โ userId       โ  โโโโโโโโโโโโโโโโ  โ
โ  โ role         โ  โ expiresAt    โ                     โ
โ  โ ...          โ  โ revoked      โ                     โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฆ Estructura de Datos

### Access Token Payload
```json
{
  "userId": "uuid-string",
  "email": "user@example.com",
  "role": "ADMIN",
  "iat": 1234567890,
  "exp": 1234578690
}
```

### Refresh Token Payload
```json
{
  "userId": "uuid-string",
  "email": "user@example.com",
  "role": "ADMIN",
  "iat": 1234567890,
  "exp": 1235172690
}
```

### Refresh Token en BD
```typescript
{
  id: "uuid",
  token: "eyJhbGciOiJIUzI1NiIs...",
  userId: "uuid-del-usuario",
  expiresAt: Date,
  createdAt: Date,
  revoked: false
}
```

## ๐ Capas de Seguridad

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Capa 1: Contraseรฑa Hasheada             โ
โ              bcrypt con 10 rounds               โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Capa 2: JWT Firmado                     โ
โ         Secret key + algoritmo HS256            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Capa 3: Token Expiration                โ
โ         Access: 3h, Refresh: 7d                 โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Capa 4: Refresh Token en BD             โ
โ         Validaciรณn de revocaciรณn                โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         Capa 5: Middleware de Autorizaciรณn      โ
โ         Validaciรณn de roles                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โฑ๏ธ Timeline de Tokens

```
Login
  โ
  โโ Access Token generado (vรกlido 3 horas)
  โ  โ
  โ  โโ Hora 0: Token vรกlido โ
  โ  โโ Hora 1: Token vรกlido โ
  โ  โโ Hora 2: Token vรกlido โ
  โ  โโ Hora 3: Token EXPIRADO โ
  โ  โโ Requiere refresh
  โ
  โโ Refresh Token generado (vรกlido 7 dรญas)
     โ
     โโ Dรญa 1-6: Token vรกlido โ
     โโ Dรญa 7: Token vรกlido โ
     โโ Dรญa 8: Token EXPIRADO โ
     โโ Requiere nuevo login
```
